---
title: "W241 Final Project Google Forms Analysis"
author: "Anni Yao"
date: "2025-04-15"
output:
  pdf_document:
    latex_engine: xelatex
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(dev = "png", dpi = 96)
```

## W241 Final Project Google Forms Analysis 

```{r}
# Load Libraries and Dataset
library(tidyverse)
library(scales)

file_path <- "C:/Users/anniy/Downloads/coffee_drinking_dataset_for_analysis.csv"
df <- read.csv(file_path, stringsAsFactors = FALSE)

df <- df %>% filter(rowSums(is.na(.)) < ncol(.))
df <- df[!is.na(df[, 7]), ]

glimpse(df)

```
**URL to the Coffee Study** https://tinyurl.com/coffeestudy2025

## Data Cleaning: 

```{r}
# Clean values from our excel sheet
colnames(df) <- make.names(colnames(df))

df <- df %>%
  rename(
    wake_time = What.time.did.you.wake.up.this.morning.,
    coffee_time = What.time.did.you.drink.your.coffee.....A..On.day.1.you.need.to.drink.coffee.20.minutes.after.waking.up.....B..On.day.2.you.need.to.drink.coffee.2.hours.after.waking.up...If.you.skipped.this.time.interval..please.don.t.submit.the.form.,
    hours_since_wake = How.many.hours.has.it.been.since.you.woke.up...For.testing.accuracy..please.complete.this.survey.6.hours.after.waking.up....If.you.re.filling.it.out.earlier.or.later.than.6.hours.after.waking.up..that.s.okay.just.be.honest.in.your.response.....,
    alertness = How.awake.do.you.feel.right.now...scale.1.5.,
    focus_difficulty = How.difficult.was.it.to.focus.on.tasks.today....scale.1.5.,
    physical_tiredness = How.physically.tired.do.you.feel.right.now.....scale.1.5.
  )

extract_number <- function(x) {
  as.numeric(gsub("[^1-5]", "", x))
}

df$coffee_amount_raw <- df$How.much.coffee.did.you.drink.today.

# Clean and convert it to numeric
df$coffee_cups <- df$coffee_amount_raw %>%
  tolower() %>%
  str_extract("\\d+(\\.\\d+)?") %>%   # extract number like "1" or "1.5"
  as.numeric()

df$alertness <- extract_number(df$alertness)
df$focus_difficulty <- extract_number(df$focus_difficulty)
df$physical_tiredness <- extract_number(df$physical_tiredness)
df$hours_since_wake <- as.numeric(df$hours_since_wake)

# Convert time to datetime and calculate coffee delay
df$wake_time <- as.POSIXct(df$wake_time, format = "%I:%M:%S %p")
df$coffee_time <- as.POSIXct(df$coffee_time, format = "%I:%M:%S %p")

df$coffee_delay_mins <- as.numeric(difftime(df$coffee_time, df$wake_time, units = "mins"))

```

## Identify Compliant Participants 

```{r}
# Define compliance flags
df$compliant_survey_time <- ifelse(df$hours_since_wake >= 5 & df$hours_since_wake <= 7, 1, 0)
df$compliant_coffee_time <- ifelse(
  df$coffee_delay_mins <= 30 | (df$coffee_delay_mins >= 90 & df$coffee_delay_mins <= 150),
  1, 0
)

# Define treatment vs control group
df$treatment_group <- ifelse(df$coffee_delay_mins >= 90, 1, 0)
df$treatment_label <- ifelse(df$treatment_group == 1, "Treatment", "Control")

# Creating a new df to filter for compliant participants only
df_compliant <- df %>%
  filter(compliant_survey_time == 1 & compliant_coffee_time == 1)
```

**Note:** We defined compliance with the survey timing as completing the survey **between 5 and 7 hours** after waking, rather than exactly at the 6-hour mark. This allowed us to include participants who followed the instructions closely, even if not perfectly. We believe this +- 1 hour window may help us maintain data quality and ensure a bigger sample size for our analysis.

## Compliance Summary 

```{r}
df %>%
  summarise(
    total_responses = n(),
    compliant_survey = mean(compliant_survey_time, na.rm = TRUE),
    compliant_coffee = mean(compliant_coffee_time, na.rm = TRUE)
  )
```
```{r}
total_counts <- df %>%
  filter(!is.na(treatment_group)) %>%
  group_by(treatment_label) %>%
  summarise(total = n())

# Count compliant participants per group
compliant_counts <- df %>%
  filter(compliant_survey_time == 1 & compliant_coffee_time == 1) %>%
  group_by(treatment_label) %>%
  summarise(compliant = n())

# Merge the two summaries
group_summary <- left_join(total_counts, compliant_counts, by = "treatment_label") %>%
  mutate(compliant = replace_na(compliant, 0),
         compliance_rate = paste0(compliant, "/", total, " (", round(100 * compliant / total), "%)"))

print(group_summary)
```

Our compliance rates were **50% in the control group** and **55% in the treatment group**. Only about half of participants followed both the coffee timing and survey timing instructions.



```{r compliance_plot, echo=FALSE}
compliance_plot_data <- df %>%
  filter(!is.na(treatment_label)) %>%
  mutate(fully_compliant = ifelse(compliant_survey_time == 1 & compliant_coffee_time == 1, "Compliant", "Non-Compliant")) %>%
  group_by(treatment_label, fully_compliant) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(treatment_label) %>%
  mutate(prop = n / sum(n),
         label = paste0(round(prop * 100), "%"),
         total = sum(n))  # Add total for each treatment group

# Create the plot
ggplot(compliance_plot_data, aes(x = treatment_label, y = prop, fill = fully_compliant)) +
  geom_col(position = "stack", width = 0.6) +
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), color = "black", size = 4.5) +
  geom_text(data = compliance_plot_data %>% distinct(treatment_label, total),
            aes(x = treatment_label, y = 1.05, label = paste0("n = ", total)),
            inherit.aes = FALSE, size = 4.5, fontface = "bold") +
  scale_y_continuous(labels = percent_format(), limits = c(0, 1.1)) +
  scale_fill_manual(values = c("salmon", "darkgreen")) +
  labs(title = "Full Compliance (Survey + Coffee) by Group",
       x = "Group", y = "Proportion", fill = "Compliance") +
  theme_minimal()


```


*How can we improve this?*

Our group discussed a few ways after the experiment to improve future compliance rates.

For any future experiments with human participants, we can:


1. Send Automated text/email reminders right before their target coffee time or survey time
2. Include a Mobile survey link with push notifications (although I'm not sure if google forms would have that feature)
3. Add Incentives for full compliance, like a gift card raffle or bonus points. Anni has offered a $25 starbucks giftcard to only one random participant. 
4. We can use a third party App-based logging tool with built-in timers to guide them through Day A and Day B. We would need to search other survey tools to identify the right one

## Linear Regression Model

```{r}
model <- lm(alertness ~ treatment_group + focus_difficulty + physical_tiredness + hours_since_wake + coffee_cups, data = df_compliant)
summary(model)

```
The updated linear regression model shows that participants who delayed their coffee had **0.36 higher alertness scores** on average compared to the control group, although this effect was still only **marginally significant (p = 0.10)**, with a **standard error of 0.20**.

- focus_difficulty and physical_tiredness goes into the Alert index score and should have somewhat of a correlation. 

- Adding how much cups of coffee participants drank that day to the model didn’t improve predictive power significantly. This suggests that timing of caffeine may be more important than the quantity consumed 

- While we observed a possible trend that delaying caffeine may improve alertness, our sample size of compliant participants using the google sheets was small. This limited our ability to detect a statistically significant effect with our models. 

- Based on our earlier power calculation, we would definitely **need more participants** (especially compliant ones) to reliably detect an effect of this size. With more data, the standard errors would likely shrink, making it easier to confirm whether this trend holds up.


```{r pressure, echo=FALSE}
ggplot(df_compliant, aes(x = factor(treatment_group, labels = c("Control", "Treatment")),
                         y = alertness)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "Alertness by Coffee Timing Group", x = "Group", y = "Alertness Score (1–5)") +
  theme_minimal()

```

